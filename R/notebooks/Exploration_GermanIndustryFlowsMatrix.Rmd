---
title: "Exploration of German Industry matrices"
output: html_notebook
---

Quick initial exploration of main characteristics from the German skills matrices. The dataset used in this case is the 'nace2.DTA', a 3-digit occupation matrix. 

Reading the data into a network object:
```{r}
library(foreign)
library(igraph)
library(dplyr)


# read data
data_nace2 <- data.frame(read.dta("../data/MR_04-17_EN_data_GermanySkillsMatrix/wz08.dta"))

# select edges where the flow is higher than random
data_nace2_df <- data_nace2[data_nace2$SRt>0,]

```
Top 20 flows:

```{r}

library(knitr)

top_nace2_df <- data_nace2_df[order(-data_nace2_df$SRt),]

kable(top_nace2_df[top_nace2_df$SRt!=1,][1:20,])

```

```{r fig.width=10, fig.height=8, echo=FALSE}
library(ggplot2)
ggplot(data = top_nace2_df, aes(x=wz08_1, y=wz08_2, fill=SRt)) + 
  geom_tile() + scale_fill_gradient(low = "orange",     high = "darkorange4") +  
  theme(axis.text.x = element_text(color = "grey20", size = 0.2, angle = 90, hjust = 1, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 0.2, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size =0.2, angle = 45, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 0.2, angle = 45, hjust = .5, vjust = .5, face = "plain")
  )

 
```




```{r}
#build the graph

nace2_net <- graph_from_data_frame(top_nace2_df,directed = FALSE)
```

```{r}
# network object
nace2_net

```

```{r}
V(nace2_net)       # The vertices of the "nace2_net" object

```

## Network and node descriptives

 The proportion of present edges from all possible edges in the network.

```{r}
edge_density(nace2_net, loops=F)
```
The proportion of reciprocated ties.

```{r}
reciprocity(nace2_net)
```
Trasitivity (clustering): measures that probability that adjacent nodes of a network are connected. In other words, if i is connected to j, and j is connected to k, what is the probability that i is also connected to k?
```{r}
transitivity(nace2_net, type="global")  # net is treated as an undirected network
```

Diameter (length of the shortest path between two nodes) in the network, get_diameter() returns the nodes along the first found path of that distance.

```{r}
diameter(nace2_net, directed=F, weights=NA)

get_diameter(nace2_net, directed=F, weights=NA) 

```

Node degrees: the number of adjacent edges to each node. 
```{r}
deg <- degree(nace2_net, mode="all")

# Ocuppations with higher incoming/outgoing flows
print (sort(deg)[1:10])
```

```{r}
# Ocuppations with lowest incoming/outgoing flows
print (sort(-deg)[1:10])
```

```{r}
hist(deg,  main="Network Node degree",xbins=100,breaks=50)

```

Degree distribution

```{r}
deg.dist <- degree_distribution(nace2_net, cumulative=T, mode="all")

plot( x=0:max(deg), y=1-deg.dist, pch=19, cex=1.2, col="orange",  xlab="Degree", ylab="Cumulative Frequency")
```

Strength is a weighted measure of degree that takes into account the number of edges that go from one node to another. 

In this example we use the mode "out", showing the number of job changes leaving the occupation.
```{r}
sort(strength(nace2_net,mode="out"))[1:5]

```


```{r}
sort(-strength(nace2_net))[1:5]

```
```{r}
hist(centr_degree(nace2_net, mode="in", normalized=T)$res,  main='Centrality',xlab="Node Centrality",breaks=50)

```
Eigenvector (centrality proportional to the sum of connection centralities), is a measure of being well-connected connected to the well-connected. 
Values of the first eigenvector of the graph matrix.

```{r}
hist(centr_eigen(nace2_net, directed=T, normalized=T)$vector,  main='Eigenvector Centrality',xlab="Node Eigenvector Centrality",breaks=50)

```


Closeness (centrality based on distance to others in the graph), measures how many steps are required to access every other node from a given node.
It’s a measure of how long information takes to arrive. Higher values mean less centrality.
Inverse of the node’s average geodesic distance to others in the network.

```{r}

centr_clo(nace2_net, mode="all", normalized=T) 

hist(centr_clo(nace2_net, mode="all", normalized=T)$res,  main='Centrality scores',xlab="The node-level centrality scores.",breaks=100)

```


```{r}
# All centralisation types
centr_degree(nace2_net)$centralization
centr_clo(nace2_net, mode = "all")$centralization
centr_betw(nace2_net, directed = FALSE)$centralization
centr_eigen(nace2_net, directed = FALSE)$centralization

```
```{r}
dg <- decompose.graph(nace2_net) # returns a list of three graphs

dg[[2]]
dg[[3]]
dg[[4]]
dg[[5]]
dg[[6]]

nace2_net_noself <- simplify(dg[[1]],remove.multiple = FALSE)

```

```{r fig.width=6, fig.height=8, echo=FALSE}
length(which(degree(nace2_net_noself)==0)) # says 0


E(nace2_net_noself)$width <- (E(nace2_net_noself)$SRt)
layout <- layout.fruchterman.reingold(nace2_net_noself)
V(nace2_net_noself)$size=degree(nace2_net_noself)/50

plot(nace2_net_noself, vertex.label=NA, layout = layout,vertex.label.font=0.5, vertex.label.color="black",
     edge.color="grey", edge.curved=.1)

```



```{r fig.width=10, fig.height=8, echo=FALSE}


ceb <- cluster_louvain(nace2_net_noself,nace2_net_noself$SRt) 
V(nace2_net_noself)$community <- ceb$membership
V(nace2_net_noself)$crossing <- crossing(ceb,nace2_net_noself)

colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange'), alpha=.6)



plot(nace2_net_noself, vertex.label=NA, layout = layout,vertex.label.font=0.5, vertex.label.color="black",
     edge.color="grey", edge.curved=.1, vertex.label.cex=0.5,vertex.color=colrs[V(nace2_net_noself)$community])


node_list <- get.data.frame(nace2_net_noself, what = "vertices")




```

```{r fig.width=8, fig.height=8, echo=FALSE}

df1 <- node_list[node_list$community==1,]
unique(df1$name)

length(which(df1$crossing==TRUE))/length(which(df1$crossing!=TRUE))



subg1 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== 1))
layout <- layout.fruchterman.reingold(subg1)

ceb_sub1 <- cluster_louvain(subg1,subg1$SRt) 
V(subg1)$community <- ceb_sub1$membership
colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange'), alpha=.6)



plot(subg1, layout=layout, vertex.label.cex=0.8,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg1)$community])

subg1_df <- get.data.frame(subg1, what = "Edges")

```

```{r fig.width=8, fig.height=8, echo=FALSE}
subg2 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== 2))

df2 <- node_list[node_list$community==2,]
unique(df2$name)

length(which(df2$crossing==TRUE))/length(which(df2$crossing!=TRUE))



layout <- layout.fruchterman.reingold(subg2)

ceb_sub2 <- cluster_louvain(subg2,subg2$SRt) 
V(subg2)$community <- ceb_sub2$membership
colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange'), alpha=.6)



plot(subg2, layout=layout, vertex.label.cex=0.8,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg2)$community])

```

```{r fig.width=8, fig.height=8, echo=FALSE}
subg3 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== 3))

df3 <- node_list[node_list$community==3,]
unique(df3$name)

length(which(df3$crossing==TRUE))/length(which(df3$crossing!=TRUE))

layout <- layout.fruchterman.reingold(subg3)

ceb_sub3 <- cluster_louvain(subg3,subg3$SRt) 
V(subg3)$community <- ceb_sub3$membership



plot(subg3, layout=layout, vertex.label.cex=0.8,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg3)$community])

```


```{r fig.width=8, fig.height=8, echo=FALSE}
subg4 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== 4))

df4 <- node_list[node_list$community==4,]
unique(df4$name)

length(which(df4$crossing==TRUE))/length(which(df4$crossing!=TRUE))

layout <- layout.fruchterman.reingold(subg4)

ceb_sub4 <- cluster_louvain(subg4,subg5$SRt) 
V(subg4)$community <- ceb_sub4$membership
colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange'), alpha=.6)



plot(subg4, layout=layout, vertex.label.cex=0.8,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg4)$community])


```


```{r fig.width=8, fig.height=8, echo=FALSE}
subg5 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== 5))

df5 <- node_list[node_list$community==5,]
unique(df5$name)

length(which(df5$crossing==TRUE))/length(which(df5$crossing!=TRUE))

layout <- layout.fruchterman.reingold(subg5)

ceb_sub5 <- cluster_louvain(subg5,subg5$SRt) 
V(subg5)$community <- ceb_sub5$membership

plot(subg5, layout=layout, vertex.label.cex=0.8,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg5)$community])
```


```{r fig.width=26, fig.height=18, echo=FALSE}


wt <- walktrap.community(nace2_net_noself, modularity=TRUE)
dend <- as.dendrogram(wt, use.modularity=TRUE)

plot(dend, nodePar=list(pch=c(NA, 20)))
```

```{r}
all_nodes <- sort(node_list$name)

edge_list <- get.data.frame(nace2_net_noself, what = "edges") %>% inner_join(node_list %>% select(name,  community), by = c("from" = "name")) %>% inner_join(node_list %>% select(name, community), by = c("to" = "name")) %>% mutate(group = ifelse(community.x == community.y, community.x, NA) %>% factor())


edge_list_df <- (edge_list %>% arrange(community.y))$name

library(ggplot2)
ggplot(data = edge_list, aes(x=from, y=to, fill=SRt)) + 
  geom_tile() + scale_fill_gradient(low = "orange",     high = "darkorange4") +  
  theme(axis.text.x = element_text(color = "grey20", size = 0.2, angle = 90, hjust = 1, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 0.2, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size =0.2, angle = 45, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 0.2, angle = 45, hjust = .5, vjust = .5, face = "plain")
  )

```

```{python}
import pandas as pd
top_nace2_df_p = pd.read_stata("../data/MR_04-17_EN_data_GermanySkillsMatrix/wz08.dta")
```
