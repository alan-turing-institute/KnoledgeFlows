---
title: "Exploration of German Industry matrices 2"
output: html_notebook
---

Quick initial exploration of main characteristics from the German skills matrices. The dataset used in this case is the 'wz08.dta', a 2-digit industry matrix. 

Reading the data into a network object:
```{r}
library(foreign)
library(igraph)
library(dplyr)


# read data
data_nace2 <- data.frame(read.dta("/Users/crangelsmith/PycharmProjects/KnowledgeFlows/data/MR_04-17_EN_data_GermanySkillsMatrix/wz08.dta"))

length(unique(c(data_nace2$wz08_1,data_nace2$wz08_2)))
              
hist(data_nace2$SRt,main="Edge weight SRt",breaks=50)

# select edges where the flow is higher than random
data_nace2_df <- data_nace2[data_nace2$SRt>0,]

```
Top 20 flows:

```{r}

library(knitr)

top_nace2_df <- data_nace2_df[order(-data_nace2_df$SRt),]

kable(top_nace2_df[top_nace2_df$SRt!=1,][1:20,])

```


```{r}
#build the graph

nace2_net <- graph_from_data_frame(top_nace2_df,directed = FALSE)

V(nace2_net)       # The vertices of the "nace2_net" object
E(nace2_net)$weight <-E(nace2_net)$SRt

```


## Network and node descriptives

 The proportion of present edges from all possible edges in the network.

```{r}
edge_density(nace2_net, loops=F)
```

Trasitivity (clustering): measures that probability that adjacent nodes of a network are connected. In other words, if i is connected to j, and j is connected to k, what is the probability that i is also connected to k?
```{r}
transitivity(nace2_net, type="global")  # net is treated as an undirected network
```

Node degrees: the number of adjacent edges to each node. 

Strength is a weighted measure of degree that takes into account the number of edges that go from one node to another. 

In this example we use the mode "out", showing the number of job changes leaving the occupation.
```{r}
sort(strength(nace2_net,mode="out"))[1:5]

```


```{r}
sort(-strength(nace2_net))[1:5]

```
```{r}
p1 <- hist(degree(nace2_net),breaks=50,plot=FALSE)
p2 <- hist(strength(nace2_net),breaks=30,plot=FALSE)

plot( p2, col=rgb(0,0,1,1/4), xlim=c(0,250),main ="Streght Degree")
plot( p1, col=rgb(1,0,0,1/4), xlim=c(0,250), add=T)  # second
legend(200,50,legend=c("degree","strength"), col=c(rgb(0,0,1,1/4),rgb(1,0,0,1/4)), bty = "n",ncol=1, pch=c(15,15),lty=c(1,2,3))


```

`
The graph is disconected. There are vertex that are only conected to themselves. 
```{r}
dg <- decompose.graph(nace2_net) # returns a list of three graphs


for (i in 2:length(dg)){
  print(V(dg[[i]]))
  print("SRt weight: ",E(dg[[i]])$SRt)

}


```

```{r fig.width=12, fig.height=12, echo=FALSE}

nace2_net_noself <- simplify(dg[[1]],remove.multiple = FALSE)

E(nace2_net_noself)$width <- (E(nace2_net_noself)$SRt)
V(nace2_net_noself)$size <- strength(nace2_net_noself)/20

E(nace2_net_noself)$weight <- (E(nace2_net_noself)$SRt)

layout <- layout.fruchterman.reingold(nace2_net_noself)

plot(nace2_net_noself, vertex.label=NA, layout = layout,vertex.label.font=0.5, vertex.label.color="black",
     edge.color="grey", edge.curved=.1)

```



```{r fig.width=10, fig.height=8, echo=FALSE}

ceb <- cluster_louvain(nace2_net_noself,nace2_net_noself$weight) 
V(nace2_net_noself)$community <- ceb$membership
V(nace2_net_noself)$crossing <- crossing(ceb,nace2_net_noself)

colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange','black'), alpha=.6)
layout <- layout.fruchterman.reingold(nace2_net_noself)


plot(nace2_net_noself, vertex.label=NA, layout = layout,vertex.label.font=0.5, vertex.label.color="black",
     edge.color="grey", edge.curved=.1, vertex.label.cex=0.5,vertex.color=colrs[V(nace2_net_noself)$community])


node_list <- get.data.frame(nace2_net_noself, what = "vertices")
```

```{r}
print (ceb$modularity)

```

```{r fig.width=8, fig.height=8, echo=FALSE}

print_cummunity_vertex <- function(node_list,community, percentage){
  
  print(paste("Community: ",community))
  
  col <- c("gray50", "tomato", "gold", "yellowgreen","blue",'orange','black')
  print (paste("Color:",col[community]))
  
  df1 <- node_list[node_list$community==community,]
  communitynames1 <- unique(df1$name)
  
  print (paste("Total number of vertices:",length(communitynames1)))


  print(paste("% of vertices connected to other communities",length(which(df1$crossing==TRUE))/length(which(df1$crossing!=TRUE))))


  sample(communitynames1, length(communitynames1)*percentage)
}

```
```{r}

print_cummunity_vertex(node_list,1, 0.2)
```
```{r}

print_cummunity_vertex(node_list,2, 0.2)
```

```{r}

print_cummunity_vertex(node_list,3, 0.3)
```

```{r}

print_cummunity_vertex(node_list,4, 0.7)
```

```{r}

print_cummunity_vertex(node_list,5, 0.25)
```

```{r}
print_cummunity_vertex(node_list,6, 0.5)
```

```{r}

print_cummunity_vertex(node_list,7, 0.2)
```



```{r fig.width=8, fig.height=8, echo=FALSE}
plot_community <- function(nace2_net_noself,community){

subg1 <- induced.subgraph(nace2_net_noself, which(V(nace2_net_noself)$community== community))

ceb_sub1 <- cluster_louvain(subg1,subg1$weight) 
V(subg1)$community <- ceb_sub1$membership
colrs <- adjustcolor( c("gray50", "tomato", "gold", "yellowgreen","blue",'orange'), alpha=.6)
layout <- layout.fruchterman.reingold(subg1)


plot(subg1, layout=layout, vertex.label.cex=0.7,vertex.label.font=0.4, vertex.label.color="black",
     edge.color="grey", edge.curved=.1,,vertex.color=colrs[V(subg1)$community])

}

plot_community(nace2_net_noself,1)


```

```{r fig.width=8, fig.height=8, echo=FALSE}
plot_community(nace2_net_noself,2)


```

```{r fig.width=8, fig.height=8, echo=FALSE}

plot_community(nace2_net_noself,3)

```


```{r fig.width=8, fig.height=8, echo=FALSE}
plot_community(nace2_net_noself,4)

```


```{r fig.width=8, fig.height=8, echo=FALSE}
plot_community(nace2_net_noself,5)

```

```{r fig.width=8, fig.height=8, echo=FALSE}

plot_community(nace2_net_noself,6)

```

```{r fig.width=8, fig.height=8, echo=FALSE}
plot_community(nace2_net_noself,7)

```


```{r fig.width=20, fig.height=8, echo=FALSE}


wt <- cluster_walktrap(nace2_net_noself, modularity=TRUE)
dend <- as.dendrogram(wt, use.modularity=TRUE)

layout <- layout.fruchterman.reingold(dg[[1]])

plot(dend, nodePar=list(pch=c(NA, 20)))


```

```{r fig.width=15, fig.height=12, echo=FALSE}

nace2_net_dend <- dg[[1]]

labels_dend <- labels(dend)

index_labels <-c(1:length(labels_dend))

label_order_df <- data.frame(name = labels_dend, index = index_labels)


E(nace2_net_dend)$width <- (E(nace2_net_dend)$SRt)
V(nace2_net_dend)$size <- strength(nace2_net_dend)/50

E(nace2_net_dend)$weight <- (E(nace2_net_dend)$SRt)

edge_list <- get.data.frame(nace2_net_dend, what = "edges") %>% inner_join(label_order_df %>% select(name,  index), by = c("from" = "name")) %>% inner_join(label_order_df %>% select(name, index), by = c("to" = "name")) %>% mutate(group = ifelse(index.x == index.y, index.x, NA) %>% factor())


library(ggplot2)
ggplot(data = edge_list, aes(x=factor(from, level = labels_dend), y=factor(to, level = labels_dend), fill=SRt)) + 
  geom_tile() + scale_fill_gradient(low = "orange",     high = "darkorange4") +  
  theme(axis.text.x = element_text(color = "grey20", size = 2.6, angle = 90, hjust = 1, vjust = .5, face = "plain"),
        axis.text.y = element_text(color = "grey20", size = 2.6, angle = 0, hjust = 1, vjust = 0, face = "plain"),  
        axis.title.x = element_text(color = "grey20", size =2.6, angle = 45, hjust = .5, vjust = 0, face = "plain"),
        axis.title.y = element_text(color = "grey20", size = 2.6, angle = 45, hjust = .5, vjust = .5, face = "plain")
       
  )

labels_dend_df <- data.frame(labels_dend)

```

```{r}
library("DT")
df = data.frame(
  first.quarter = labels_dend[1:150], 
  second.quarter = labels_dend[151:300],
  third.quarter = labels_dend[301:450],
  fourth.quarter = labels_dend[451:600]
)
DT::datatable(df)
```

